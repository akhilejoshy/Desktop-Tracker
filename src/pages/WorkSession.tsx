import { useEffect } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { Card, CardContent } from "../components/ui/card";
import { Button } from "../components/ui/button";
import { Switch } from "../components/ui/switch";
import { Label } from "../components/ui/label";
import { useAppSelector, useAppDispatch } from "@/store/hooks";
import { useTime } from "../contexts/TimeContext";
import { X, Clock, Keyboard, MousePointerClick, LogOut } from "lucide-react";
import { useMonitoring } from "@/contexts/MonitoringContext";
import { updateWorkingStatus } from "@/store/slices/taskSlice";


const formatSeconds = (seconds: number) => {
  const h = Math.floor(seconds / 3600).toString().padStart(2, "0");
  const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, "0");
  const s = Math.floor(seconds % 60).toString().padStart(2, "0");
  return `${h}:${m}:${s}`;
};

export default function WorkSessionPage() {
  const dispatch = useAppDispatch()

  const { subtaskId, workDiaryId, taskActivityId } = useParams<{ subtaskId: string, workDiaryId: string, taskActivityId: string }>();
  const navigate = useNavigate();
  const { sessionWorkSeconds, isTimerRunning, setTimerRunning, startTimer, stopTimer } = useTime();
  const { stopMonitoring, latestLogEntry } = useMonitoring();

  useEffect(() => {
    if (subtaskId && taskActivityId && workDiaryId) {
      localStorage.setItem("subtaskId", subtaskId.toString())
      localStorage.setItem("taskActivityId", taskActivityId)
      localStorage.setItem("workDiaryId", workDiaryId)
    }
  }, [subtaskId, taskActivityId])

  function openExternalLink() {
    const url = 'https://preview--cloudhouse-logistics.lovable.app/staff/work-diary';
    if (window.electron?.openExternal) {
      window.electron.openExternal(url);
    } else {
      console.warn(`Electron bridge not available â€” opening URL in web context: ${url}`);
      window.open(url, '_blank');
    }
  }

  const handleToggle = async (isRunning: boolean) => {
    setTimerRunning(isRunning);
    if (!isRunning) {
      stopTimer();
      if (subtaskId && taskActivityId && workDiaryId) {
        stopMonitoring(subtaskId, Number(workDiaryId), Number(taskActivityId));
      }
      try {
        await dispatch(updateWorkingStatus(false)).unwrap();
      } catch (err) {
        return;
      }
      navigate("/dashboard");
    }
  };
  const projects = useAppSelector((state) => state.task.projectsData);
  const subtask = projects
    .flatMap((p) => (p.tasks ?? []))
    .flatMap((t) => (t.subtasks ?? []))
    .find((st) => st.id === Number(subtaskId));

  if (!subtask) return <div>Subtask not found.</div>;
  const totalSubtaskTime = 0 + sessionWorkSeconds;

  return (
    <div className="flex flex-col h-full space-y-4">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-bold">{subtask.name}</h2>
        <div className="flex items-center gap-2 space-y-2">
          <Label className={`font-semibold ${isTimerRunning ? "text-primary" : "text-muted-foreground"} m-0`}>
            {isTimerRunning ? "Start" : "Stop"}
          </Label>
          <Switch className="bg-[#0b2479]" checked={isTimerRunning} onCheckedChange={handleToggle} />
        </div>
      </div>

      <div className="mt-2 mb-5">
        {latestLogEntry ? (
          <Card key={latestLogEntry.subtaskId} className="relative group overflow-hidden rounded-md border-0 ">
            <CardContent className="p-0  ">
              <div>
                {latestLogEntry.screenshot && (
                  <img
                    src={`data:image/jpeg;base64,${latestLogEntry.screenshot}`}
                  />
                )}
              </div>
              <div className="absolute bottom-0 left-0 right-0 bg-black/50 backdrop-blur-sm p-2 text-white 
                    rounded-b-md">
                <div className="flex justify-between items-center text-xs">
                  <div className="flex items-center gap-1">
                    <Clock size={12} />
                    <span>
                      {latestLogEntry.endTime}
                    </span>
                  </div>
                  <div className="flex items-center gap-1">
                    <Keyboard size={12} />
                    <span>{latestLogEntry.keyActions}</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <MousePointerClick size={12} />
                    <span>{latestLogEntry.mouseActions}</span>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        ) : (
          <div className=" flex justify-center items-center min-h-32 bg-gray-300 rounded-md  border-2 border-dashed border-gray-400"  >

            <svg width="100" height="100" viewBox="0 0 343 343" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M265.139 282.769H70.1264C66.422 282.769 63.4207 279.768 63.4207 276.064V148.399C63.4207 144.695 66.422 141.693 70.1264 141.693H265.139C268.843 141.693 271.845 144.695 271.845 148.399V276.046C271.845 279.768 268.843 282.769 265.139 282.769Z" fill="#B8BBC0" />
              <path d="M99.0584 248.315L133.736 177.708C135.897 173.318 141.933 172.786 144.832 176.714L180.418 225.059C182.973 228.524 188.135 228.609 190.794 225.214L200.878 212.368C203.57 208.938 208.836 209.076 211.339 212.66L235.692 247.44C238.711 251.762 235.624 257.696 230.359 257.696H104.907C100.087 257.696 96.9318 252.637 99.0584 248.315Z" fill="white" />
              <path d="M198.117 186.386C203.535 186.386 207.927 181.994 207.927 176.576C207.927 171.159 203.535 166.767 198.117 166.767C192.699 166.767 188.307 171.159 188.307 176.576C188.307 181.994 192.699 186.386 198.117 186.386Z" fill="white" />
              <path d="M264.333 163.714C262.292 163.714 260.32 162.599 259.308 160.661C257.885 157.883 258.965 154.487 261.743 153.064C262.258 152.789 275.12 145.741 272.428 130.237C270.13 116.997 257.37 115.591 257.233 115.574C254.129 115.265 251.865 112.504 252.174 109.4C252.482 106.296 255.243 104.032 258.348 104.341C265.756 105.061 280.557 111.012 283.558 128.316C286.851 147.353 274.126 159.392 266.923 163.114C266.099 163.525 265.208 163.714 264.333 163.714Z" fill="#A2A5AB" />
              <path d="M237.459 79.1987C184.843 51.6215 135.605 86.4188 135.605 86.4188L139.858 87.9109L130.134 89.6087L127.202 110.172L98.6468 141.659H134.507C129.242 148.965 130.803 158.363 125.864 163.542C115.831 174.072 121.542 179.149 139.189 177.743C156.837 176.319 145.878 153.012 160.078 148.948C165.429 147.421 168.91 144.592 171.157 141.676H209.024C207.481 152.618 212.591 161.484 219.571 162.256C231.508 163.577 231.182 175.856 231.182 175.856C228.129 178.789 227.649 181.035 227.906 182.527C228.146 183.848 229.313 184.826 230.65 184.928C259.857 187.261 245.948 155.156 245.948 155.156C245.948 155.156 290.075 106.776 237.459 79.1987Z" fill="#A2A5AB" />
              <path d="M148.313 124.32C152.343 120.685 154.11 115.162 152.892 109.863C149.582 95.5255 138.092 65.9246 100.053 73.1619C62.8204 80.2449 61.397 110.943 63.0605 125.967C63.6951 131.781 67.6053 136.703 73.1276 138.589C80.7422 141.196 93.6561 143.391 112.83 139.755C131.935 136.102 142.619 129.448 148.313 124.32Z" fill="#A2A5AB" />
              <path d="M60.488 75.4429C60.368 80.0048 60.6424 96.0743 70.2464 99.4014L85.5613 82.5258C85.5613 82.5258 81.9255 74.7226 61.74 74.2424C61.054 74.2252 60.5052 74.7569 60.488 75.4429ZM136.737 61.0369C138.572 65.3758 144.06 80.2449 136.411 86.7962L115.968 76.7291C115.968 76.7291 116.483 68.1713 134.97 60.3337C135.674 60.0593 136.445 60.368 136.737 61.0369Z" fill="#A2A5AB" />
              <path d="M83.5719 106.724C83.2118 106.724 82.8859 106.467 82.8173 106.09C82.7316 105.678 83.006 105.267 83.4347 105.198L92.0612 103.552C92.4728 103.466 92.8844 103.74 92.953 104.169C93.0387 104.581 92.7643 104.992 92.3356 105.061L83.7091 106.707C83.6577 106.707 83.6062 106.724 83.5719 106.724ZM120.204 99.7444C119.844 99.7444 119.518 99.4871 119.45 99.127C119.364 98.7154 119.638 98.3038 120.067 98.2352L128.694 96.5888C129.105 96.503 129.517 96.7774 129.585 97.2062C129.671 97.6178 129.397 98.0294 128.968 98.098L120.342 99.7444C120.307 99.7444 120.256 99.7444 120.204 99.7444ZM102.248 119.535C101.648 119.535 101.031 119.433 100.43 119.227C98.9555 118.712 97.9265 117.649 97.6864 116.38C97.6006 115.968 97.875 115.557 98.3038 115.488C98.7154 115.402 99.127 115.677 99.1956 116.105C99.3328 116.809 100.002 117.46 100.945 117.786C101.94 118.129 103.38 118.163 104.478 117.22C105.73 116.14 106.107 114.116 105.593 111.372C105.507 110.961 105.781 110.549 106.21 110.48C106.622 110.395 107.033 110.669 107.102 111.098C107.891 115.282 106.656 117.375 105.49 118.386C104.598 119.124 103.449 119.535 102.248 119.535Z" fill="#232323" />
              <path d="M111.303 117.803C108.988 117.803 106.484 116.14 105.575 111.355C105.49 110.943 105.764 110.532 106.193 110.463C106.604 110.377 107.016 110.652 107.085 111.081C107.788 114.751 109.588 116.654 111.938 116.226C113.636 115.9 115.008 114.408 114.768 113.139C114.682 112.727 114.956 112.315 115.385 112.247C115.797 112.161 116.208 112.435 116.277 112.864C116.671 114.974 114.785 117.272 112.23 117.752C111.921 117.786 111.612 117.803 111.303 117.803Z" fill="#232323" />
              <path d="M101.082 110.995C101.528 113.379 106.707 113.104 106.707 113.104C106.707 113.104 111.612 111.458 111.166 109.074C110.703 106.69 100.619 108.611 101.082 110.995ZM134.062 104.752C133.633 104.752 133.29 104.409 133.29 103.98C133.29 103.552 133.633 103.209 134.044 103.209C134.164 103.209 146.272 103.037 154.024 97.3777C154.367 97.1204 154.847 97.2062 155.105 97.5492C155.362 97.8922 155.276 98.3724 154.933 98.6296C146.787 104.581 134.593 104.735 134.062 104.752C134.079 104.752 134.079 104.752 134.062 104.752ZM142.088 109.417C137.371 109.417 133.736 108.765 133.461 108.714C133.05 108.645 132.758 108.234 132.844 107.822C132.912 107.41 133.324 107.119 133.736 107.205C133.839 107.222 144.797 109.177 153.304 106.261C153.715 106.124 154.144 106.33 154.281 106.742C154.419 107.136 154.213 107.582 153.801 107.719C149.96 109.023 145.706 109.417 142.088 109.417ZM66.2161 117.58C63.9866 117.58 61.6885 117.357 59.4762 116.774C59.0646 116.671 58.8245 116.243 58.9274 115.831C59.0303 115.419 59.459 115.179 59.8706 115.282C69.1831 117.7 80.4849 113.413 80.605 113.361C80.9994 113.207 81.4453 113.413 81.5997 113.807C81.754 114.202 81.5482 114.648 81.1538 114.802C80.7765 114.956 73.865 117.58 66.2161 117.58ZM63.8494 124.818C63.4378 124.818 63.0948 124.492 63.0777 124.08C63.0605 123.651 63.3864 123.291 63.8151 123.274C72.8017 122.863 82.2685 117.032 82.3714 116.963C82.7316 116.74 83.2118 116.843 83.4347 117.203C83.6577 117.563 83.5548 118.043 83.1946 118.266C82.8002 118.524 73.2819 124.372 63.9009 124.801C63.8666 124.818 63.8494 124.818 63.8494 124.818ZM69.0973 95.6798C68.9601 95.6798 68.8229 95.6455 68.6857 95.5598C61.174 90.8092 61.3112 76.3861 61.3284 75.7858C61.3284 75.3571 61.6714 75.0312 62.1173 75.0312C62.546 75.0312 62.889 75.3914 62.8719 75.8201C62.8719 75.9573 62.7347 89.986 69.5261 94.2735C69.8862 94.4965 69.9891 94.9767 69.7662 95.3368C69.5947 95.5598 69.3374 95.6798 69.0973 95.6798ZM120.204 74.088C120.067 74.088 119.93 74.0537 119.81 73.9679C119.45 73.745 119.33 73.2648 119.553 72.9046C122.605 67.9311 133.959 61.4656 134.439 61.1912C134.816 60.9854 135.279 61.1054 135.485 61.4827C135.691 61.86 135.571 62.3231 135.193 62.5289C135.073 62.5975 123.703 69.0802 120.856 73.6935C120.719 73.9679 120.462 74.088 120.204 74.088ZM209.487 139.893C209.436 139.893 209.384 139.893 209.333 139.875C208.921 139.79 208.647 139.395 208.715 138.966C211.682 123.651 223.19 116.963 223.687 116.671C224.065 116.466 224.528 116.586 224.734 116.963C224.939 117.34 224.819 117.803 224.442 118.009C224.322 118.078 213.054 124.663 210.225 139.258C210.173 139.635 209.847 139.893 209.487 139.893ZM172.066 140.51C171.843 140.51 171.637 140.424 171.483 140.236C171.208 139.91 171.243 139.429 171.569 139.155C174.193 136.891 174.518 131.712 174.518 131.661C174.536 131.232 174.913 130.906 175.324 130.94C175.753 130.957 176.079 131.335 176.045 131.746C176.028 131.986 175.685 137.629 172.563 140.321C172.426 140.441 172.237 140.51 172.066 140.51ZM123.017 174.604C122.965 174.604 122.897 174.604 122.845 174.587C122.434 174.501 122.177 174.09 122.262 173.661C123.103 169.854 127.527 166.286 127.716 166.149C128.042 165.892 128.539 165.943 128.796 166.269C129.054 166.595 129.002 167.092 128.676 167.35C128.642 167.384 124.492 170.711 123.754 174.004C123.686 174.364 123.36 174.604 123.017 174.604ZM126.996 175.959C126.944 175.959 126.876 175.959 126.824 175.942C126.413 175.856 126.155 175.444 126.241 175.016C127.081 171.208 131.506 167.641 131.695 167.504C132.021 167.247 132.518 167.298 132.775 167.624C133.033 167.95 132.981 168.447 132.655 168.705C132.621 168.739 128.471 172.066 127.733 175.359C127.665 175.719 127.356 175.959 126.996 175.959ZM230.702 183.711C230.342 183.711 230.033 183.471 229.947 183.111C229.141 179.509 232.691 176.954 232.846 176.851C233.189 176.611 233.669 176.696 233.926 177.039C234.166 177.382 234.08 177.863 233.737 178.12C233.686 178.154 230.873 180.195 231.456 182.785C231.542 183.196 231.285 183.608 230.873 183.711C230.805 183.711 230.753 183.711 230.702 183.711ZM234.732 184.019C234.389 184.019 234.08 183.779 233.977 183.436C233.137 180.041 236.79 177.931 236.944 177.828C237.322 177.623 237.785 177.743 237.991 178.12C238.196 178.497 238.076 178.96 237.699 179.166C237.648 179.2 234.904 180.812 235.469 183.059C235.572 183.471 235.315 183.882 234.904 183.985C234.869 184.002 234.801 184.019 234.732 184.019Z" fill="#232323" />
            </svg>


          </div>
        )
        }
      </div>
      <div className="shrink-0 flex items-center justify-between pt-2 border-t">
        <div className="text-left">
          <p className="text-xs text-muted-foreground">Subtask Time</p>
          <p className="text-lg font-semibold tabular-nums">{formatSeconds(totalSubtaskTime)}</p>
        </div>
        <Button variant="outline" onClick={openExternalLink}>Work Diary</Button>
      </div>

    </div>

  );
}
